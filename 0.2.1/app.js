app=angular.module("SongPane",[]),function(a){var b="//api.songpane.com/",c="kid_Ve5MJ5EOhM",d="03910d2676f34fd5bcae148188556e06";a.config(["$routeProvider","$httpProvider",function(a,b){a.when("/").when("/set/:setId/:songId").when("/:view/:songId").otherwise("/"),delete b.defaults.headers.common["X-Requested-With"],b.defaults.headers.common["X-Kinvey-Api-Version"]="2",b.defaults.cache=!1,b.responseInterceptors.push(["$q","$injector","notifier","locale","util",function(a,b,c,d,e){function f(d){var e=d.status;return 0===e?d.data=h.noConnection:401==e?(g=g||b.get("auth"),g.isLoggedIn()&&(g.logout(),c.notify({message:d.data=h.loggedOut,icon:"alert"}))):404==e?c.notify({message:d.data=h.notFound,icon:"alert"}):c.notify({message:d.data=h.genericError,icon:"alert"}),a.reject(d)}var g,h=d._;return function(a){return a.then(e.identity,f)}}])}]).run(["$rootScope","auth","ws","collection","util","transitioner","keyboard","modal","notifier","$window","locale",function(a,e,f,g,h,i,j,k,l,m,n){var o,p,q=m.navigator,r=n._;m.notify=l.notify,e.setup({url:b+"user/"+c+"/",key:c,secret:d}),"standalone"in q&&!q.standalone&&l.notify({message:r.standalone,icon:"songpane"}),a._=r,a.change=!1,a.$on("ready",function(){a.ready=!0}),a.$on("login",function(){a.loginClass="",a.requireLogin&&i.apply("login",function(){a.requireLogin=!1}),f("ws://ws.songpane.com:8000").send("auth",e.token()).on("me",function(a){var b=a.sets;o.sort(function(a,c){return b.indexOf(a._id)-b.indexOf(c._id)}).store(),e.save(a,!0)}),o=a.sets=g({songs:[],isNeeded:function(a){var b=this.songs,c=a.songs;return c.forEach(function(a){var d=a._id;c[d]=a,h.list(b,d)}),!0},getSong:function(a,b){var c,d,e=this[a].songs;for(d=0,c=e.length;c>d;d++)if(e[d]._id==b)return e[d]},url:b+"appdata/"+c+"/set/",params:{query:{_id:{$in:e.me().sets}}},onNew:function(a){var b=e.me(),c=b.sets,d=a._id;return c.push(d),e.save(b),a},hasSong:function(a){return-1!==this.songs.indexOf(a)?!0:!1}}),p=a.songs=g({url:b+"appdata/"+c+"/song/",params:{ids:o.songs},isNeeded:function(a){return f.sub("song."+a._id),this.isOwner(a)||o.hasSong(a._id)?!0:!1},getKey:function(a,b){var c=b&&o.getSong(b,a),d=p[a];return c&&c.key||d.key}}),o.run(function(){p.run(function(){f.on("set",function(b){var c=[],d=e.me();o.update(b),~d.sets.indexOf(b._id)||(l.notify({title:r.sharedSet,message:b.title,icon:"sets"}),d.sets.push(b._id),e.save(d,!0)),o.store(),b.songs.forEach(function(a){p[a._id]||c.push(a._id)}),c.length?p.query({ids:c}):a.$apply()}),f.on("song",function(b){p.update(b),a.$apply()}),a.$emit("ready")})})}),a.$on("logout",function(){a.ready=!1,k(),f.close(),o.deleteStore(),p.deleteStore(),o=p=a.sets=a.songs=null,a.requireLogin=!0}),e.isLoggedIn()?a.$emit("login"):a.requireLogin=!0,a.modal=k,a.toggleState=function(b){a[b]=!a[b],a.changedState=!0},a.resetState=function(){return a.changedState?(a.changedState=!1,void 0):(["menu","em"].forEach(function(b){a[b]&&(a[b]=!1)}),void 0)},j.on("ctrl+shift",function(){a.slow=!a.slow}).on(["h","?"],function(){return k("keyboard"),a.$apply(),!1}).on("esc",function(){return!1})}])}(app),app.controller("addController",["$scope","$routeParams","$rootScope",function(a,b,c){var d=c.sets,e=c.songs;a.s=d.filter(function(a){return d.isWriter(a)}),a.addNew=function(a){var c=b.songId;return e.keep(c),d.save({title:a,songs:[{_id:c}]})},a.addExisting=function(a){var c=b.songId,f=d[a],g=f.songs;return g[c]?!0:(g.push(g[c]={_id:c}),e.keep(c),d.save(f))}}]),app.controller("confirmController",["$scope","$routeParams","$rootScope","util","$location",function(a,b,c,d,e){var f=c.sets,g=c.songs;a.trashSong=function(){var a=b.songId,c=b.setId;return f.forEach(function(b){d.unlist(b.songs,a)||f.remove(b._id)}),e.path((c?"set":b.view)+"/"+(f[c]?c+"/":"")),g.remove(a)}}]),app.controller("loginController",["$scope","auth","locale","md5",function(a,b,c,d){var e=c._;a.login=function(c,d){a.message=e.wait,b.login(c,d,function(b,c){b||(a.message="InvalidCredentials"==c.error?e.invalidCredentials:e.genericError)})},a.reset=function(c){a.message=e.wait,b.reset(c,function(b){a.message=b?e.checkEmail:e.genericError})},a.md5=d,a.message=""}]),app.controller("newController",["$scope","$rootScope","transposer","songMode","$routeParams","util","locale","notifier",function(a,b,c,d,e,f,g,h){var i=b.songs,j=e.edit,k=g._;a.songMode=d,a.langs=g.langs,j&&(a.song=f.extend({},i[e.songId]),"clone"==j&&delete a.song._id,a.song.tempo=a.song.tempo-0),a.saveSong=function(a,b){var d="("+c.getScale(a.key).join("|")+")";return~a.body.search("^(?:\\[[1-9BCPIO]\\]\\n(?:(?: *"+d+"[1-9adgijmsu,\\(\\)]*(?:\\/"+d+")?)*\\n[^\\[\\n].+\\S(?:\\n|$))+)+$")?(a._acl={},b&&(a._acl={gr:!1}),i.save(a)):(h.notify({message:k.checkBody,icon:"alert"}),void 0)},a.keys=c.getAllKeys()}]),app.controller("renameController",["$scope","$rootScope",function(a,b){var c=b.sets;a.renameSet=function(a,b){var d=c[a];return b!==d.title?(d.title=b,c.save(d)):!1}}]),app.controller("searchController",["$scope","$rootScope","locale",function(a,b,c){var d=b.songs;a._=c._,a.message="",a.search=function(b){a.s=a.n=!0,b=b.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1"),b=b.replace(/([a-zA-Z])/g,function(a){return"["+a.toLowerCase()+a.toUpperCase()+"]"}),b="^[\\s\\S]*"+b,d.query({query:{body:{$regex:b}},limit:100},function(b){a.results=b,a.s=!1})}}]),app.controller("settingsController",["$scope","auth","settings",function(a,b,c){a.s=c.settings,a.toggle=function(a){c.toggle(a)},a.setFont=function(a){c.set("fontSize",a)},a.logout=function(){return b.logout(),!0}}]),app.controller("shareController",["$scope","$routeParams","$rootScope","md5","util",function(a,b,c,d,e){var f=e.list,g=e.unlist,h=c.sets,i=b.setId,j=a.e=h.getWriters(i).slice(0),k=a.c=h.getReaders(i).slice(0);a.owner=h.getOwner(i),a.md5=d,a.allowAccess=function(a,b){return f(k,a),"edit"==b?f(j,a):g(j,a),!0},a.denyAccess=function(a){g(j,a),g(k,a)},a.isOwner=function(){return h.isOwner(h[i])},a.save=function(){return h.setReaders(i,k).setWriters(i,j).save(h[i])}}]),app.controller("uiController",["$scope","$rootScope","$routeParams","$location","settings","util","keyboard","transposer","transitioner","locale","$timeout","store","auth","ws","modal",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(a,b,c){var d,e,g,i,j,k,l,m,n,o=[];return a.split("[").forEach(function(a){if(""!==a){for(d=a.split("]"),k="",g=d[1].replace(/[\r\t\v\f\0\x0B]|^\n+|\s+$/g,"").split("\n"),i=0,j=g.length;j>i;i+=2){for(e=g[i+1],e.length<g[i].length&&(e+=f.pad(g[i].length-e.length," ")),n=0,l=/\S+/g;m=l.exec(g[i]);)k+=e.substring(n,m.index)+'<span class="c"><span>'+(b!==c?h.transpose(m[0],b,c):m[0])+"</span></span>",n=m.index;k+=g[i+1].substr(n)+"\n"}o.push({type:d[0].toLowerCase(),text:k})}}),o}var q,r=j._,s=b.sets,t=b.songs,u=b.songSlide={to:"left"},v=b.viewSlide={to:"left"};b.r=c,b.p=function(a){d.path(a)},b.q=function(a,b){d.search(a,b)},b._=r,a.s=e.settings,a.nextSong=function(){var a,b,e=c.setId,f=c.songId;e&&f&&(a=s[e].songs,a.forEach(function(a,c){a._id==f&&(b=c)}),b<a.length-1?b++:b=0,d.path("/set/"+e+"/"+a[b]._id))},a.prevSong=function(){var a,b,e=c.setId,f=c.songId;e&&f&&(a=s[e].songs,a.forEach(function(a,c){a._id==f&&(b=c)}),b>0?b--:b=a.length-1,d.path("/set/"+e+"/"+a[b]._id))},a.getKeys=function(){return c.songId&&t[c.songId]&&h.getKeys("m"===t[c.songId].key.slice(-1))||[]},a.pad=f.pad,a.trashSet=function(){d.path("/"),s.remove(c.setId)},a.duplicateSet=function(){var a=s[c.setId];d.path("set/"+s.save({title:a.title+" ("+r.copy+")",songs:a.songs.slice(0)})+"/")},a.rmSong=function(b){var e=c.setId,f=s[e],g=f.songs;d.path("set/"+e+"/"),g.splice(b,1),g.length?s.save(f):a.trashSet()},a.curKey=function(){var a=c.songId;return a&&t.getKey(a,c.setId)},n.on("set",function(b){var d=c.setId,e=c.songId;d==b._id&&b.songs.forEach(function(b){b._id==e&&a.updateKey(b.key||t[e].key,!0)})}),a.updateKey=function(b,d){var e,f,g=c.setId,h=c.songId,i=t[h];g&&(e=s[g],f=s.getSong(g,h),b!==i.key?f.key=b:delete f.key,!d&&s.save(e)),a.k!=b&&(u.model=p(i.body,i.key,b),a.k=b)},a.clean=function(a){delete this[a]},a.sortSet=function(a,b){f.move(s,a,b);var c=m.me();f.move(c.sets,a,b),m.save(c)},a.sortSong=function(a,b){var d=s[c.setId];f.move(d.songs,a,b),s.save(d)},a.isSongOwner=function(){return c.songId&&t.isOwner(t[c.songId])},a.editSong=function(a){d.search("edit",a?"clone":void 0),o("new")},a.canChangeKey=function(){var a=c.setId;return a?s.isWriter(s[a]):!0},a.$on("$routeChangeSuccess",function(b,c,e){if("/"===d.path())return s.length?d.path("sets/"):d.path("search/"),void 0;if(c){var f,g,h,j,k=c.params.view,m=c.params.setId,n=c.params.songId;if(e&&(f=e.params.view,g=e.params.setId,h=e.params.songId),k){if(-1==["sets","catalog","search"].indexOf(k))return s.length?d.path("sets/"):d.path("search/"),void 0;g?(v.to="right",v.model=k):k!=f&&(v.to="left",v.model=k)}if(m){if(!s[m])return s.length?d.path("sets/"):d.path("search/"),void 0;m!=g&&(v.force=!0,v.to="left",v.model="set")}if(n){if(!t[n])return d.path(k+"/"),void 0;j=p(t[n].body,t[n].key,t.getKey(n,m)),a.k=a.curKey(),e?n!==h&&(g&&g===m&&s[m].songs.indexOf(n)<s[m].songs.indexOf(h)?(u.to="right",u.model=j):(u.to="left",u.model=j)):(u.to="left",u.model=j)}else h&&i.apply("song-view",function(){u.model=""});l.set("path",d.path())}}),g.on(["left","k"],function(){return a.$apply(function(){a.prevSong()}),!1}).on("c",function(){return a.$apply(function(){e.toggle("hideChords")}),!1}).on("=",function(){var b=e.settings.fontSize||0;2>b&&(e.set("fontSize",b+1),a.$apply())}).on("-",function(){var b=e.settings.fontSize||0;b&&(e.set("fontSize",b-1),a.$apply())}),q=l.get("path"),"/"==d.path()&&q?d.path(q):a.$emit("$routeChangeSuccess",{params:c})}]),app.directive("editor",["$window","util","parse",function(a,b,c){var d=a.document,e=a.setTimeout,f=a.clearTimeout;return{restrict:"E",replace:!0,transclude:!0,scope:{mode:"&",placeholder:"@",model:"="},template:'<div class="editor"><div class="editor-inner"><div></div><span class="hide"></span><textarea class="input" placeholder="{{placeholder}}" ng-model="model" ng-transclude></textarea></div></div>',link:function(a,g){g=g.children()[0];var h,i=g.children,j=i[0],k=b.element(i[1]),l=i[2],m=a.mode(),n=b.throttle,o=0,p=function(){var a=l.selectionStart||0;a!=o&&(k.attr("pad",l.value.substr(0,a)).removeClass("hide"),o=a)},q=function(){var a=d.createElement("div");p(),c(l.value,m,function(b,c){var e;c&&"chords"!=c?(e=a.appendChild(d.createElement("span")),e.className=c):e=a,e.appendChild(d.createTextNode(b))}),g.replaceChild(a,j),j=a};b.element(l).bind("input",n(q,10)).bind("focus",function(){!function a(){p(),f(h),h=e(a,100)}()}).bind("blur",function(){f(h),k.addClass("hide"),o=null}),e(q,50)}}}]),app.directive("spFocus",["$timeout","util",function(a){function b(a){if(a&&0!==a.length){var b=(""+a).toLowercase;a=!("f"==b||"0"==b||"false"==b||"no"==b||"n"==b||"[]"==b)}else a=!1;return a}return function(c,d,e){function f(){a(function(){g.focus()},400)}var g=d[0];0===e.spFocus.length?f():c.$watch(e.spFocus,function(a){b(a)&&g.focus()})}}]),app.directive("spIf",function(){return{transclude:"element",priority:1e3,terminal:!0,compile:function(a,b,c){return function(a,b,d){var e,f;a.$watch(d.spIf,function(d){d?e||(f=a.$new(),c(f,function(a){e=a,b.after(a)})):e&&(e.remove(),f.$destroy(),e=f=void 0)})}}}}),app.directive("img",function(){return{restrict:"E",link:function(a,b){b.bind("error",function(){b.addClass("hide")}),b.bind("load",function(){b.removeClass("hide")})}}}),app.directive("spNotifier",["util","notifier","transitioner","$compile","touch","$timeout",function(a,b,c,d,e,f){return{link:function(g,h){function i(b){function i(){m||(m=!0,k.removeClass("tl"),c.after(k,function(){k.remove(),n.$destroy(),k=n=null}))}var k,l,m,n=g.$new();a.extend(n,b),k=a.element(h.prepend(j).children()[0]),d(k.contents())(n),f(function(){k.addClass("tl")}),e.tap(k,i),l=f(i,b.delay||5e3)}var j='<div class="notification"><article ng-class="\'icon-\'+icon"><h6>{{title}}</h6><p>{{message}}</p></article></div>';b.setCallback(i).get().forEach(i)}}}]),app.directive("spParse",["touch","util",function(){return function(a,b,c){var d=a.$eval(c.spParse),e=b.find("div"),f=b.find("textarea"),g=function(){var a=f.val();e.html(d(a)||"")};f.bind("keyup",g)}}]),app.directive("spSlide",["util","transitioner",function(a,b){return{transclude:"element",priority:1e3,terminal:!0,compile:function(a,c,d){return function(a,e){var f,g,h,i=c.spSlide,j=e.parent();j.addClass("t3d"),a.$watch(function(a){var c,k=a.$eval(i);!k.model&&h&&(g.remove(),f.$destroy(),g=f=h=null),k.model&&(k.model!=h||k.force)&&(k.force=!1,c=a.$new(),c.model=k.model,d(c,function(a){if(e.after(a),g){var d=g,i=f;"left"==k.to?(a.addClass("tr"),j.addClass("transition tl")):(a.addClass("tl"),j.addClass("transition tr")),g.bind("$destroy",function(){j.removeClass("transition tl tr"),a.removeClass("tr tl")}),b.apply(j[0].id,function(){d.remove(),i.$destroy()})}g=a,f=c,h=k.model}))})}}}}]),app.directive("spSortable",["touch","$timeout","util",function(a,b,c){function d(a){var b=0;do b+=a.prop("offsetTop")-a.prop("scrollTop"),a=c.element(a.prop("offsetParent"));while(void 0!==a.prop("offsetTop"));return b}function e(){i&&i.css("margin",""),h+1<l.length&&(i=l.eq(h+1),i.css("marginTop",j-1+"px"))}var f,g,h,i,j,k,l,m,n,o,p=Math.min,q=Math.max;return function(r,s,t){r.$watch(t.spSortable,function(u){u||void 0===u?(a.hold(s,function(a,c){a.preventDefault(),l=s.children();var i=l.eq(0);o=d(s),k=i.prop("offsetTop")-i.prop("scrollTop"),j=l[0].offsetHeight-1,n=j*l.length,m=p(q(0,c.y-o-k),n),g=h=p(Math.floor(m/j),l.length-1),f=l.eq(g),f.addClass("dragged").css("top",p(q(m+k-j/2,0),n-j/2)+"px"),b(function(){s.addClass("sorting")},0,!1),e()}),a.drag(s,function(a,b){a.preventDefault(),o=d(s);var c=p(q(0,b.y-o-k),n);if(f.css("top",p(q(c+k-j/2,k),n-j/2-k)+"px"),h!==p(Math.floor(c/j),l.length-1)){var g=Math.round(c/j);g!==h&&g!==h+1&&(g>h?(l.splice(g-1,0,l.splice(h,1)[0]),h=g-1):(l.splice(g,0,l.splice(h,1)[0]),h=g),e())}}),a.release(s,function(a){a.preventDefault(),s.removeClass("sorting"),i.css("margin",""),f.removeClass("dragged").css("top",""),r.$apply(t.onsort+"("+g+","+h+")")})):(a.hold(s,c.noop),a.drag(s,c.noop),a.release(s,c.noop))})}}]),app.directive("spTap",["touch","keyboard",function(a,b){return function(c,d,e){a.tap(d,function(){return c.$apply(e.spTap)}),e.spKbd&&b.on(c.$eval(e.spKbd),function(){return c.$apply(e.spTap)})}}]),app.value("songMode",{startState:function(){return{next:"part"}},token:function(a,b){var c=null;return"part"==b.next?a.match(/^\[[1-9BCPIO]\](?=$|\n)/)?(c="part",b.next="chords"):a.skip():"chords"==b.next?a.eat("\n")?(c="chords",b.next="chord"):a.skip():"chord"==b.next?a.eat("\n")?b.next="text":a.eatWhile(" ")?/^[A-G]$/.test(a.peek())||a.skip():a.match(/^[A-G][#b12345679adgijmsu,\(\)]*(?:\/[A-G][#b]?)?(?=($| +|\n))/)?c="chord":a.skip():"text"==b.next?a.match(/^.+\S/)?(c="text",b.next="partOrChords"):a.skip():"partOrChords"==b.next?a.match(/^\n(?=\[)/)?b.next="part":a.eat("\n")?(c="chords",b.next="chord"):a.skip():a.skip(),c}}),app.factory("auth",["$rootScope","$http","store","$window",function(a,b,c,d){function e(){return!!j}function f(){b.defaults.headers.common.Authorization=e()?"Kinvey "+j:"Basic "+d.btoa(h.key+":"+h.secret)}function g(d,e,g){b.post(h.url+"login",{username:d,password:e}).success(function(b){j=b._kmd.authtoken,i=b,delete i._kmd.authtoken,c.set("me",i),c.set("token",j),f(),a.$emit("login"),g(!0,i)}).error(function(a){g(!1,a)})}var h={},i=c.get("me"),j=c.get("token"),k={setup:function(a){for(var b in a)h[b]=a[b];f()},isLoggedIn:e,reset:function(a,c){b.post(h.url,{username:a}).error(function(a){c(!1,a)}).success(function(){c(!0)})},login:g,logout:function(){b.post(h.url+"_logout"),i=j=null,c.remove("me").remove("token"),f(),a.$emit("logout")},id:function(){return i&&i._id},me:function(){return i},token:function(){return j},save:function(a,d){return c.set("me",i=a),d||b.put(h.url+encodeURIComponent(i._id),a),!0}};return k}]),app.factory("collection",["store","auth","$http","$timeout","util",function(a,b,c,d,e){var f=function(a){return a._kmd&&a._kmd.lmt&&Date.parse(a._kmd.lmt)||0},g=function(b){var c,d=this;return c=a.get(d.url),c&&(d.pending=a.get(d.url+":pending")||[],d.add(c,b,!0)),d.syncDown(function(){d.syncUp(null,b||e.noop)}),d},h=function(a){var b=this;return c.get(e.buildUrl(b.url,b.params)).success(function(a){a.forEach(function(a){b[a._id]?b.saveLocal(a):b.add(a,null,!0)}),b.store()}).success(a||e.noop).error(a||e.noop),b},i=function(a,b){var d=this,f=d.pending.length;return f?(d.pending.forEach(function(g){c({method:"PUT",url:d.url+encodeURIComponent(g),data:d[g]||{_id:g,status:"trash"}}).success(function(c){d[g]&&d.saveLocal(c),e.unlist(d.pending,g),a&&a(g),!--f&&b&&b()}).error(function(){!--f&&b&&b()})}),d):(b&&b(),d)},j=function(a,b){var d=this;return c.get(d.url+a).success(function(a){d.add(a,b)}),d},k=function(a,b){var d=this;return c.get(e.buildUrl(d.url,a)).success(function(a){d.add(a,b)}).error(function(){b&&b()}),d},l=function(a){var b=this;b[a._id]?b.saveLocal(a):b.add(a,null,!0)},m=function(a){var b=this,c=a._id;"trash"==a.status?b.removeLocal(c):e.extend(b[c],a)},n=function(a,b,c){var d,g,h=this;e.toArray(a).forEach(function(a){"trash"!=a.status&&(h[a._id]||(h.isNeeded(a)?(h.push(a),g=f(a),g>h.lmt&&(h.lmt=g,h.params.query["_kmd.lmt"].$gt=new Date(g).toISOString()),d=!0):h.aux.push(a),h[a._id]=a))}),!c&&d&&h.store(),b&&b.call(h,a)},o=function(a){var b=this;e.unlist(b,b[a]),delete b[a],e.unlist(b.pending,a)},p=function(a){var b=this;return b[a].status="trash",e.unlist(b,b[a]),b.save(b[a],function(){b.removeLocal(a)})},q=function(a,c){var d=this,f=a._id;if(f||(f=a._id=e.generateId(),a._acl||(a._acl={}),a._acl.creator=b.id(),!d.onNew||d.onNew(a)))return d[f]?e.extend(d[f],a):d.push(d[f]=a),e.list(d.pending,f),d.syncUp(c||function(){d.store()}),f},r=function(a){var b=this,c=b[a];return c&&!~b.indexOf(c)&&b.push(c),b.store()},s=function(){var b=this;return a.set(b.url,b),a.set(b.url+":pending",b.pending),b},t=function(){var b=this;return a.remove(b.url).remove(b.url+":pending"),b},u=function(a){return a._acl.creator==b.id()},v=function(a){return this.isOwner(a)||a._acl.w&&~a._acl.w.indexOf(b.id())},w=function(a){return this[a]._acl.creator},x=function(a,b){var c=this,d=c[a]._acl.r;return d||(d=c[a]._acl.r=[]),e.list(d,b),c},y=function(a,b){var c=this,d=c[a]._acl.w;return d||(d=c[a]._acl.w=[]),e.list(d,b),c},z=function(a,b){var c=this,d=c[a]._acl.r;return d&&e.unlist(d,b),c},A=function(a,b){var c=this,d=c[a]._acl.w;return d&&e.unlist(d,b),c},B=function(a){var b=this[a]._acl;return b&&b.r||[]},C=function(a){var b=this[a]._acl;return b&&b.w||[]},D=function(a,b){var c=this,d=c[a]._acl;return d.r=b,c},E=function(a,b){var c=this,d=c[a]._acl;return d.w=b,c};return function(a){var b,c=[],d={url:"",run:g,save:q,remove:p,isOwner:u,isWriter:v,getOwner:w,syncDown:h,addWriter:y,addReader:x,removeWriter:A,removeReader:z,getReaders:B,getWriters:C,setReaders:D,setWriters:E,add:n,saveLocal:m,removeLocal:o,update:l,params:{},lmt:0,aux:[],pending:[],query:k,get:j,keep:r,syncUp:i,store:s,deleteStore:t,isNeeded:function(){return!0}};return e.extend(c,d,a),b=c.params,b.query=b.query||{},b.query["_kmd.lmt"]={$gt:"0"},c}}]),app.factory("keyboard",["$document","$timeout",function(a,b){function c(a){var c,d,e,g=a.keyCode,h=a.type;if((93==g||224==g)&&(g=91),g>95&&106>g&&(g-=48),110==g&&(g=190),109==g&&(g=189),111==g&&(g=191),"keyup"==h&&(e=j.indexOf(g),-1!==e&&j.splice(e,1)),c=a.target,3==c.nodeType&&(c=c.parentNode),"INPUT"==c.tagName||"SELECT"==c.tagName||"TEXTAREA"==c.tagName||c.contentEditable&&"true"==c.contentEditable){if(27!=g)return;c.blur()}if("keydown"==h){if(-1!==j.indexOf(g))return;j.push(g),f&&b.cancel(f),f=b(function(){j.length=0},1e3,!1)}d=i[h+":"+j.join("+")],d&&d.forEach(function(b){b(a)===!1&&(a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),a.returnValue=!1,a.cancelBubble=!0)})}function d(a,b){var c=[],d="+"===a?["+"]:a.split("+");return d.forEach(function(a){h[a]&&(c.push(16),a=h[a]),g[a]&&c.push(g[a])}),b+":"+c.join("+")}function e(a,b){var c,e;for(e in a)c=d(e,b),i[c]||(i[c]=[]),i[c].push(a[e])}var f,g={backspace:8,tab:9,enter:13,"return":13,shift:16,ctrl:17,control:17,alt:18,option:18,capslock:20,esc:27,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,ins:45,insert:45,del:46,"delete":46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,meta:91,command:91,"super":91,windows:91,"*":106,"+":107,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},h={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},i={},j=[];a.bind("keydown",c),a.bind("keyup",c);var k={on:function(){var a=arguments,b=a[0],c=a[2],d={};return"string"==typeof b?d[b]=a[1]:Array.isArray(b)?b.forEach(function(b){d[b]=a[1]}):(d=a[0],c=a[1]),e(d,c||"keydown"),this},off:function(a,b){var c=d(a,b);return i[c]&&delete i[c],this},reset:function(){return i={},this}};return k}]),app.factory("locale",function(){var a={},b=a.langs=[{code:"cs",name:"Czech","native":"Česky"},{code:"da",name:"Danish","native":"Dansk"},{code:"de",name:"German","native":"Deutsch"},{code:"en",name:"English","native":"English"},{code:"es",name:"Spanish","native":"Español"},{code:"fr",name:"French","native":"Français"},{code:"it",name:"Italian","native":"Italiano"},{code:"lv",name:"Latvian","native":"Latviešu"},{code:"lt",name:"Lithuanian","native":"Lietuvių"},{code:"hu",name:"Hungarian","native":"Magyar"},{code:"nl",name:"Dutch","native":"Nederlands"},{code:"no",name:"Norwegian","native":"Norsk"},{code:"pl",name:"Polish","native":"Polski"},{code:"pt",name:"Portuguese","native":"Português"},{code:"ro",name:"Romanian","native":"Română"},{code:"sq",name:"Albanian","native":"Shqip"},{code:"sk",name:"Slovak","native":"Slovenčina"},{code:"sl",name:"Slovene","native":"Slovenščina"},{code:"fi",name:"Finnish","native":"Suomi"},{code:"sv",name:"Swedish","native":"Svenska"},{code:"tr",name:"Turkish","native":"Türkçe"},{code:"el",name:"Greek","native":"Ελληνικά"},{code:"bg",name:"Bulgarian","native":"български"},{code:"ru",name:"Russian","native":"Pусский"},{code:"uk",name:"Ukrainian","native":"Українська"}];return a._={newSong:"New Song",editSong:"Edit Song",addToSet:"Add to Set",renameSet:"Rename Set",shareSet:"Share Set",settings:"Settings",noConnection:"Could not connect to the server!",outOfSync:"SongPane is out of sync. Please make sure you have an active internet connection.",quotaExceeded:"The local storage limit has been reached or local storage is disabled.",alert:"Alert",copy:"copy",keyboard:"Keyboard Shortcuts",illegalOperation:"You tried to perform an illegal operation!",key:"Key",currentKey:"Current Key",originalKey:"Original Key",tempo:"Tempo",signature:"Signature",timeSignature:"Time Signature",artist:"Artist(s)",copyright:"Copyright",profile:"Profile",buddies:"Buddies",remove:"Remove",owner:"Owner",save:"Save",add:"Add",addToNewSet:"Add the song to a new set",addToExistingSet:"or an existing set",selectSet:"Select a set",hideChords:"Hide chords",disconnect:"Disconnect",disconnectAccount:"Disconnect account",songTitle:"Song title",lyricsAndChords:"Lyrics and chords",nameSet:"Give this set a name",done:"Done",email:"Email",password:"Password",createAccount:"Create Account",resetPassword:"Reset Password",searchSongs:"Search songs",filterSongs:"Filter songs",sets:"Sets",catalog:"Catalog",search:"Search",noSets:"No Sets",creatingSets:"Sets are created by adding songs to them.",emptyCatalog:"Empty Catalog",aboutCatalog:"The catalog contains all the songs that you use or songs that you add to SongPane.",noResults:"No Results",searching:"Searching...",wait:"Wait...",standalone:"To enjoy this app to the fullest we recommend adding it to your Home Screen.",loggedOut:"You have been logged out.",notFound:"The resource was not found on the server.",genericError:"Something went wrong and it’s probably our fault.",confirm:"Are you sure?",explainDelSong:"Deleting the song makes it unavailable to any set that is currently using it!",del:"Delete",cancel:"Cancel",nextSongOrSet:"Next song or set",prevSongOrSet:"Previous song or set",toggleChords:"Toggle chord display",changeFontSize:"Decrease/increase font size",fontSize:"Font size",small:"Small",medium:"Medium",large:"Large",priv:"Private",pub:"Public",language:"Language",visibility:"Visibility",toggleFullscreen:"Toggle fullscreen",toggleInfo:"Toggle song info",toggleHelp:"Toggle help (this screen)",toggleSettings:"Toggle settings",esc:"Cancel actions, close modal windows",checkBody:"Please check the body of the song.",sharedSet:"A new set has been shared with you!",checkEmail:"Please check your email.",invalidCredentials:"Invalid credentials!",SPInvalidData:"The data you submitted was invalid.",SPOperationNotPermitted:"You are trying to perform an illegal operation.",SPInvalidQuery:""},b.forEach(function(a){b[a.code]=a}),a}),app.factory("md5",function(){function a(a,b){var g=a[0],h=a[1],i=a[2],j=a[3];g=c(g,h,i,j,b[0],7,-680876936),j=c(j,g,h,i,b[1],12,-389564586),i=c(i,j,g,h,b[2],17,606105819),h=c(h,i,j,g,b[3],22,-1044525330),g=c(g,h,i,j,b[4],7,-176418897),j=c(j,g,h,i,b[5],12,1200080426),i=c(i,j,g,h,b[6],17,-1473231341),h=c(h,i,j,g,b[7],22,-45705983),g=c(g,h,i,j,b[8],7,1770035416),j=c(j,g,h,i,b[9],12,-1958414417),i=c(i,j,g,h,b[10],17,-42063),h=c(h,i,j,g,b[11],22,-1990404162),g=c(g,h,i,j,b[12],7,1804603682),j=c(j,g,h,i,b[13],12,-40341101),i=c(i,j,g,h,b[14],17,-1502002290),h=c(h,i,j,g,b[15],22,1236535329),g=d(g,h,i,j,b[1],5,-165796510),j=d(j,g,h,i,b[6],9,-1069501632),i=d(i,j,g,h,b[11],14,643717713),h=d(h,i,j,g,b[0],20,-373897302),g=d(g,h,i,j,b[5],5,-701558691),j=d(j,g,h,i,b[10],9,38016083),i=d(i,j,g,h,b[15],14,-660478335),h=d(h,i,j,g,b[4],20,-405537848),g=d(g,h,i,j,b[9],5,568446438),j=d(j,g,h,i,b[14],9,-1019803690),i=d(i,j,g,h,b[3],14,-187363961),h=d(h,i,j,g,b[8],20,1163531501),g=d(g,h,i,j,b[13],5,-1444681467),j=d(j,g,h,i,b[2],9,-51403784),i=d(i,j,g,h,b[7],14,1735328473),h=d(h,i,j,g,b[12],20,-1926607734),g=e(g,h,i,j,b[5],4,-378558),j=e(j,g,h,i,b[8],11,-2022574463),i=e(i,j,g,h,b[11],16,1839030562),h=e(h,i,j,g,b[14],23,-35309556),g=e(g,h,i,j,b[1],4,-1530992060),j=e(j,g,h,i,b[4],11,1272893353),i=e(i,j,g,h,b[7],16,-155497632),h=e(h,i,j,g,b[10],23,-1094730640),g=e(g,h,i,j,b[13],4,681279174),j=e(j,g,h,i,b[0],11,-358537222),i=e(i,j,g,h,b[3],16,-722521979),h=e(h,i,j,g,b[6],23,76029189),g=e(g,h,i,j,b[9],4,-640364487),j=e(j,g,h,i,b[12],11,-421815835),i=e(i,j,g,h,b[15],16,530742520),h=e(h,i,j,g,b[2],23,-995338651),g=f(g,h,i,j,b[0],6,-198630844),j=f(j,g,h,i,b[7],10,1126891415),i=f(i,j,g,h,b[14],15,-1416354905),h=f(h,i,j,g,b[5],21,-57434055),g=f(g,h,i,j,b[12],6,1700485571),j=f(j,g,h,i,b[3],10,-1894986606),i=f(i,j,g,h,b[10],15,-1051523),h=f(h,i,j,g,b[1],21,-2054922799),g=f(g,h,i,j,b[8],6,1873313359),j=f(j,g,h,i,b[15],10,-30611744),i=f(i,j,g,h,b[6],15,-1560198380),h=f(h,i,j,g,b[13],21,1309151649),g=f(g,h,i,j,b[4],6,-145523070),j=f(j,g,h,i,b[11],10,-1120210379),i=f(i,j,g,h,b[2],15,718787259),h=f(h,i,j,g,b[9],21,-343485551),a[0]=k(g,a[0]),a[1]=k(h,a[1]),a[2]=k(i,a[2]),a[3]=k(j,a[3])}function b(a,b,c,d,e,f){return b=k(k(b,a),k(d,f)),k(b<<e|b>>>32-e,c)}function c(a,c,d,e,f,g,h){return b(c&d|~c&e,a,c,f,g,h)}function d(a,c,d,e,f,g,h){return b(c&e|d&~e,a,c,f,g,h)}function e(a,c,d,e,f,g,h){return b(c^d^e,a,c,f,g,h)}function f(a,c,d,e,f,g,h){return b(d^(c|~e),a,c,f,g,h)}function g(b){var c,d=b.length,e=[1732584193,-271733879,-1732584194,271733878];for(c=64;c<=b.length;c+=64)a(e,h(b.substring(c-64,c)));b=b.substring(c-64);var f=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(c=0;c<b.length;c++)f[c>>2]|=b.charCodeAt(c)<<(c%4<<3);if(f[c>>2]|=128<<(c%4<<3),c>55)for(a(e,f),c=0;16>c;c++)f[c]=0;return f[14]=8*d,a(e,f),e}function h(a){var b,c=[];for(b=0;64>b;b+=4)c[b>>2]=a.charCodeAt(b)+(a.charCodeAt(b+1)<<8)+(a.charCodeAt(b+2)<<16)+(a.charCodeAt(b+3)<<24);return c}function i(a){for(var b="",c=0;4>c;c++)b+=m[a>>8*c+4&15]+m[a>>8*c&15];return b}function j(a){for(var b=0;b<a.length;b++)a[b]=i(a[b]);return a.join("")}function k(a,b){return a+b&4294967295}function l(a){return j(g(a||""))}var m="0123456789abcdef".split("");return l}),app.factory("modal",["$rootScope","$location","$routeParams","transitioner","$timeout",function(a,b,c,d,e){function f(a){b.search("modal",a||null)}var g=function(b){return a.modalClass?(a.modalClass="",d.apply("modal",function(){f(),b!=c.modal&&e(function(){f(b)})})):b&&f(b),!0};return g.isOn=function(b){return b?a.modalClass===b:a.modalClass},g}]),app.factory("notifier",function(){var a,b={title:"",icon:"info",delay:5e3},c=[],d=Object.keys;return{setCallback:function(b){return a=b,this},notify:function(e){return d(b).forEach(function(a){e[a]||(e[a]=b[a])}),c.push(e),a&&a(e),this},get:function(){return c}}}),app.factory("parse",["$window",function(){function a(a){var b=this;b.pos=b.start=0,b.string=a}return a.prototype={eof:function(){return this.pos>=this.string.length},sof:function(){return!this.pos},eol:function(){return this.pos>=this.string.length||"\n"==this.string.charAt(this.pos)},sol:function(){return!this.pos||"\n"==this.string.charAt(this.pos-1)},peek:function(){return this.string.charAt(this.pos)||null},next:function(){return this.pos<this.string.length&&this.string.charAt(this.pos++)},eat:function(a){var b,c=this.string.charAt(this.pos);return b="string"==typeof a?c==a:c&&(a.test?a.test(c):a(c)),b?(++this.pos,c):void 0},eatWhile:function(a){for(var b=this.pos;this.eat(a););return this.pos>b},eatSpace:function(){for(var a=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>a},skip:function(){this.pos=this.string.length},skipTo:function(a){var b=this.string.indexOf(a,this.pos);return~b?(this.pos=b,!0):void 0},skipLine:function(){return this.skipTo("\n")&&this.pos<this.string.length&&++this.pos},backUp:function(a){this.pos-=a},column:function(){return this.start},match:function(a,b){if("string"!=typeof a){var c=this.string.slice(this.pos).match(a);return c&&b!==!1&&(this.pos+=c[0].length),c}return this.string.indexOf(a,this.pos)==this.pos?(b!==!1&&(this.pos+=a.length),!0):void 0},current:function(){return this.string.slice(this.start,this.pos)}},function(b,c,d){var e,f,g=c.startState()||!0;for(e=new a(b);!e.eof();)f=c.token(e,g),d(e.current(),f),e.start=e.pos}}]),function(){var a,b=navigator.userAgent;/AppleWebKit/.test(b)&&/Mobile\/\w+/.test(b)?a="ios":~b.toLowerCase().indexOf("firefox")&&(a="ff"),a&&(document.documentElement.className+=" "+a),app.constant("platform",a)}(),app.factory("settings",["store","util",function(a,b){var c={},d=function(b,d){c[b]=d,a.set("settings",c)};return b.extend(c,a.get("settings")||{}),{settings:c,set:d,toggle:function(a){d(a,!c[a])}}}]),app.service("store",["notifier","$window","locale",function(a,b,c){var d=b.localStorage,e=this;e.set=function(b,e){try{d.setItem(b,JSON.stringify(e))}catch(f){a.notify({message:c.quotaExceeded})}return e},e.get=function(a){return JSON.parse(d.getItem(a))},e.remove=function(a){return d.removeItem(a),e}}]),app.factory("touch",["$window","$timeout","util",function(a,b){function c(a){return s&&(a=a.touches[0]||a.changedTouches[0]),{x:a.pageX,y:a.pageY}}function d(a){var b=c(a);return b.dx=b.x-p.x,b.dy=b.y-p.y,b}function e(a,b){return x(w(b.x-a.x,2)+w(b.y-a.y,2))}function f(a){m=!0,p=c(a),n=a.target,q=b(function(){i("hold",p,a),o=!0},1e3)}function g(a){m&&(o?i("drag",d(a),a):b.cancel(q))}function h(a){m&&(b.cancel(q),o?i("release",d(a),a):e(c(a),p)<10&&i("tap",a),n=m=o=!1)}function i(a,b,c){for(var d,e,f=n;f&&f!=t&&(d=f.parentNode,e=u.indexOf(f),-1==e||!v[e][a]||!1!==v[e][a](c,b));)f=d}var j,k,l,m,n,o,p,q,r={},s="ontouchstart"in a,t=a.document,u=[],v=[],w=Math.pow,x=Math.sqrt;return s?(j="touchstart",k="touchmove",l="touchend"):(j="mousedown",k="mousemove",l="mouseup"),t.addEventListener(j,f,!0),t.addEventListener(k,g,!0),t.addEventListener(l,h,!0),["tap","hold","drag","release"].forEach(function(a){r[a]=function(b,c){b.length&&(b=b[0]);
var d=u.indexOf(b);-1==d&&(d=u.push(b)-1,v[d]={}),v[d][a]=c}}),r}]),app.factory("transitioner",["$rootScope","$document","util",function(a,b,c){function d(){var a,c=b[0].createElement("dummy"),d={transition:"transitionend",OTransition:"oTransitionEnd",MSTransition:"msTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(a in d)if(void 0!==c.style[a])return d[a]}var e=d(),f={},g=[];return e&&b.bind(e,function(b){var c=b.target.id;if(c&&c in f){for(;f[c].length;)a.$apply(f[c].shift());delete f[c]}}),{apply:function(a,b,c){return e?(a in f&&!c||(f[a]=[]),f[a].push(b),void 0):(b(),void 0)},after:function(a,b,d){a[0]&&(a=a[0]),a.id||(a.id=c.generateId()),this.apply(a.id||g.push(a)-1,b,d)}}}]),app.factory("transposer",function(){var a=/C##|D##|E##|F##|G##|A##|B##|Cbb|Dbb|Ebb|Fbb|Gbb|Abb|Bbb|C#|D#|E#|F#|G#|A#|B#|Cb|Db|Eb|Fb|Gb|Ab|Bb|C|D|E|F|G|A|B/g,b=[["C","C#","Db","D","Eb","E","F","F#","Gb","G","Ab","A","Bb","B","Cb"],["Am","A#m","Bbm","Bm","Cm","C#m","Dm","D#m","Ebm","Em","Fm","F#m","Gm","G#m","Abm"]],c=[["C","C#","Db","D","D#","Eb","E","E#","Fb","F","F#","Gb","G","G#","Ab","A","A#","Bb","B","B#","Cb"],["C#","C##","D","D#","D##","E","E#","E##","F","F#","F##","G","G#","G##","A","A#","A##","B","B#","B##","C"],["Db","D","Ebb","Eb","E","Fb","F","F#","Gbb","Gb","G","Abb","Ab","A","Bbb","Bb","B","Cb","C","C#","Dbb"],["D","D#","Eb","E","E#","F","F#","F##","G#","G","G#","Ab","A","A#","Bb","B","B#","C","C#","C##","Db"],["Eb","E","Fb","F","F#","Gb","G","G#","Abb","Ab","A","Bbb","Bb","B","Cb","C","C#","Db","D","D#","Ebb"],["E","E#","F","F#","F##","G","G#","G##","Ab","A","A#","Bb","B","B#","C","C#","C##","D","D#","D##","Eb"],["F","F#","Gb","G","G#","Ab","A","A#","Bbb","Bb","B","Cb","C","C#","Db","D","D#","Eb","E","E#","Fb"],["F#","F##","G","G#","G##","A","A#","A##","Bb","B","B#","C","C#","C##","D","D#","D##","E","E#","E##","F"],["Gb","G","Abb","Ab","A","Bbb","Bb","B","Cbb","Cb","C","Dbb","Db","D","Ebb","Eb","E","Fb","F","F#","Gbb"],["G","G#","Ab","A","A#","Bb","B","B#","Cb","C","C#","Db","D","D#","Eb","E","E#","F","F#","F##","Gb"],["Ab","A","Bbb","Bb","B","Cb","C","C#","Dbb","Db","D","Ebb","Eb","E","Fb","F","F#","Gb","G","G#","Abb"],["A","A#","Bb","B","B#","C","C#","C##","Db","D","D#","Eb","E","E#","F","F#","F##","G","G#","G##","Ab"],["Bb","B","Cb","C","C#","Db","D","D#","Ebb","Eb","E","Fb","F","F#","Gb","G","G#","Ab","A","A#","Bbb"],["B","B#","C","C#","C##","D","D#","D##","Eb","E","E#","F","F#","F##","G","G#","G##","A","A#","A##","Bb"],["Cb","C","Dbb","Db","D","Ebb","Eb","E","Fbb","Fb","F","Gbb","Gb","G","Abb","Ab","A","Bbb","Bb","B","Cbb"]];return{getKeys:function(a){return b[Number(a)]},getAllKeys:function(){return b[0].concat(b[1])},getScale:function(a){return c[b["m"===a.slice(-1)?1:0].indexOf(a)]},transpose:function(d,e,f){var g="m"===e.slice(-1)?1:0,h=b[g].indexOf(e),i=b[g].indexOf(f);return d.replace(a,function(a){return c[i][c[h].indexOf(a)]})}}}),function(a,b){app.service("util",["$window",function(c){var d=this,e=c.document,f=c.setTimeout,g=c.clearTimeout;d.toArray=function(a){return a&&a.forEach?a:[a]},d.list=function(a,b){var c=a.length;return d.toArray(b).forEach(function(b){var c=a.indexOf(b);~c||a.push(b)}),a.length-c},d.unlist=function(a,b){var c=a.indexOf(b);return~c&&a.splice(c,1),a.length},d.move=function(a,b,c){return a.splice(c,0,a.splice(b,1)[0]),a},d.pad=function(a,b){return Array(a+1).join(b||" ")},d.buildUrl=function(c,e){if(!e)return c;var f=[];return a.forEach(e,function(c,e){null!==c&&c!==b&&(a.isObject(c)&&(c=d.toJson(c)),f.push(encodeURIComponent(e)+"="+encodeURIComponent(c)))}),c+(-1==c.indexOf("?")?"?":"&")+f.join("&")},d.element=function(b){return a.isString(b)&&(b=e.getElementById(b)),a.element(b)},d.randomHex=function(a){for(var b="";a>0;)b+=Math.floor(Math.random()*Math.pow(10,16)).toString(16).substr(0,8>a?a:8),a-=8;return b},d.generateId=function(){return Math.floor(Date.now()/1e3).toString(16)+d.randomHex(16)},d.throttle=function(a,b){var c=null;return function(){var d=this,e=arguments;g(c),c=f(function(){a.apply(d,e),c=null},b)}},d.keys=Object.keys,d.toJson=c.JSON.stringify,["copy","extend","forEach","identity","fromJson","isObject","isString","isArray","lowercase","noop"].forEach(function(b){d[b]=a[b]})}])}(angular),app.factory("ws",["$rootScope","util","$window","$timeout",function(a,b,c,d){function e(a,c){return j&&(a&&(g=a),c&&(h=c),f=new j(g,b.toArray(h)),b.extend(f,m),e.emit("connecting")),e}var f,g,h,i,j=c.WebSocket,k=[],l=[],m={onopen:function(a){k.forEach(function(a){f.send(a)}),k.length=0,l.forEach(function(a){e.send("subscribe",{channel:a})}),e.emit("open",a)},onclose:function(a){return f=null,i?(i=!1,e.emit("close",a),void 0):(d(e,5e3),void 0)},onerror:function(a){e.emit("error",a)},onmessage:function(a){var c=b.fromJson(a.data);e.emit(c.event,c.data)}};return e.on=function(b,c){return a.$on(b,function(a,b){c(b)})},e.emit=function(b,c){return a.$emit(b,c)},e.sub=function(a){return e.send("subscribe",{channel:a}),b.list(l,a),function(){e.send("unsubscribe",{channel:a}),b.unlist(l,a)}},e.send=function(a,c){var d=b.toJson({event:a,data:c});return 1==f.readyState?f.send(d):k.push(d),e},e.close=function(){f&&(i=!0,f.close())},e}]);